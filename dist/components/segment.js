"use strict";

var _classCallCheck = require("babel-runtime/helpers/class-call-check")["default"];

var _inherits = require("babel-runtime/helpers/inherits")["default"];

var _get = require("babel-runtime/helpers/get")["default"];

var _createClass = require("babel-runtime/helpers/create-class")["default"];

var _core = require("babel-runtime/core-js")["default"];

var _require = require("../helpers/utils");

var uniqueId = _require.uniqueId;
var accessors = _require.accessors;

var _require2 = require("../core/layer");

var Layer = _require2.Layer;

var Segment = (function (_Layer) {
  function Segment() {
    _classCallCheck(this, Segment);

    _get(_core.Object.getPrototypeOf(Segment.prototype), "constructor", this).call(this);
    // set layer defaults
    this.params({
      type: "segment",
      opacity: 1,
      edits: ["x", "y", "width", "height"],
      handlerWidth: 2,
      handlerOpacity: 0
    });

    this.__minWidth = 1;

    // initialize data accessors
    this.y(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return +d.y || 0;
      d.y = +v;
    });

    this.height(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return +d.height || 1;
      d.height = +v;
    });

    this.duration(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return +d.duration || 1;
      d.duration = +v;
    });

    this.start(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return +d.start || 0;
      d.start = +v;
    });

    this.color(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return d.color ? d.color + "" : "#000000";
      d.color = v + "";
    });

    this.opacity(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) return d.opacity;
      d.opacity = v + "";
    });
  }

  _inherits(Segment, _Layer);

  _createClass(Segment, {
    getAccessors: {

      // @NOTE add some caching system ?

      value: function getAccessors() {
        var _this = this;

        // reverse yScale to have logical sizes
        // only y is problematic this way
        var xScale = this.base.xScale;
        var yScale = this.yScale.copy();
        yScale.range(yScale.range().slice(0).reverse());
        var height = yScale.range()[1];
        var minDomain = xScale.domain()[0];

        var _x = this.start();
        var _y = this.y();
        var _w = this.duration();
        var _h = this.height();

        var _color = this.color();
        var _opacity = this.opacity();

        // define accesors
        var x = function (d) {
          return xScale(_x(d));
        };
        var w = function (d) {
          var width = xScale(minDomain + _w(d));
          return width < 0 ? 0 : width;
        };
        var h = function (d) {
          return yScale(_h(d));
        };
        var y = function (d) {
          return height - h(d) - yScale(_y(d));
        };

        var color = function (d) {
          return _color(d);
        };
        var opacity = function (d) {
          return _opacity(d) || _this.param("opacity");
        };

        var _handlerWidth = parseInt(this.param("handlerWidth"), 10);
        var _halfHandler = _handlerWidth * 0.5;

        // handler position
        var rhx = function (d) {
          var width = w(d);

          return width < _handlerWidth * 2 ? _handlerWidth + _this.__minWidth : width - _halfHandler;
        };

        return { w: w, h: h, x: x, y: y, color: color, opacity: opacity, xScale: xScale, yScale: yScale, rhx: rhx };
      }
    },
    update: {
      value: function update(data) {
        _get(_core.Object.getPrototypeOf(Segment.prototype), "update", this).call(this, data);

        this.items = this.g.selectAll("." + this.param("unitClass")).data(this.data());

        var sel = this.items.enter().append("g").classed("item", true).classed(this.param("unitClass"), true);

        sel.append("rect");

        if (this.param("interactions").editable) {
          sel.append("line").attr("class", "handle left").attr("stroke-width", this.param("handlerWidth")).attr("stroke-opacity", this.param("handlerOpacity"));

          sel.append("line").attr("class", "handle right").attr("stroke-width", this.param("handlerWidth")).attr("stroke-opacity", this.param("handlerOpacity"));
        }

        this.items.exit().remove();
      }
    },
    draw: {
      value: function draw() {
        var el = arguments[0] === undefined ? null : arguments[0];

        el = el || this.items;

        var accessors = this.getAccessors();

        el.attr("transform", function (d) {
          return "translate(" + accessors.x(d) + ", " + accessors.y(d) + ")";
        });

        el.selectAll("rect").attr("x", 0).attr("y", 0).attr("width", accessors.w).attr("height", accessors.h).attr("fill", accessors.color).attr("fill-opacity", accessors.opacity);

        if (!!this.each()) {
          el.each(this.each());
        }

        if (this.param("interactions").editable) {

          var _handlerWidth = parseInt(this.param("handlerWidth"), 10);
          var _halfHandler = _handlerWidth * 0.5;

          el.selectAll(".handle.left").attr("x1", _halfHandler).attr("x2", _halfHandler).attr("y1", 0).attr("y2", accessors.h).style("stroke", accessors.color);

          el.selectAll(".handle.right").attr("x1", 0).attr("x2", 0).attr("y1", 0).attr("y2", accessors.h).attr("transform", function (d) {
            return "translate(" + accessors.rhx(d) + ", 0)";
          }).style("stroke", accessors.color);
        }
      }
    },
    xZoom: {
      value: function xZoom(val) {
        this.draw();
      }
    },
    handleBrush: {

      // logic performed to select an item from the brush

      value: function handleBrush(extent, e) {}
    },
    handleDrag: {
      value: function handleDrag(item, e) {
        if (item === null) {
          return;
        }

        var classList = e.target.classList;
        var mode = "move";
        // if the target is an handler
        if (classList.contains("left")) {
          mode = "resizeLeft";
        }
        if (classList.contains("right")) {
          mode = "resizeRight";
        }

        this[mode](item, e.originalEvent.dx, e.originalEvent.dy);
      }
    },
    move: {
      value: function move(item, dx, dy) {
        item = this.d3.select(item);
        var datum = item.datum();
        // define constrains
        var constrains = this.param("edits");
        var canX = !! ~constrains.indexOf("x");
        var canY = !! ~constrains.indexOf("y");
        // early return if cannot edit x and y
        if (!canX && !canY) {
          return;
        }
        // else lock the corresponding axis
        if (!canX) {
          dx = 0;
        }
        if (!canY) {
          dy = 0;
        }

        var accessors = this.getAccessors();

        var xScale = accessors.xScale;
        var yScale = accessors.yScale;
        var xRange = xScale.range();
        var yRange = yScale.range();

        var x = accessors.x(datum);
        var w = accessors.w(datum);
        var h = accessors.h(datum);
        var y = yScale(this.y()(datum));

        // handle x position - lock to boundaries
        var targetX = x + dx;
        /*
        if (targetX >= xRange[0] && (targetX + w) <= xRange[1]) {
          x = targetX;
        } else if (targetX < xRange[0]) {
          x = xRange[0];
        } else if ((targetX + w) > xRange[1]) {
          x = xRange[1] - w;
        }
        */
        if (targetX >= xRange[0] && targetX + w <= xRange[1]) {
          x = targetX;
        } else if (targetX < xRange[0]) {
          x = xRange[0];
        } else if (targetX + w > xRange[1]) {
          x = targetX;
        }

        // handle y position - lock to boundaries
        var targetY = y - dy;
        var yDisplayed = yRange[1] - h - targetY;

        if (yDisplayed >= yRange[0] && yDisplayed + h <= yRange[1]) {
          y = targetY;
        } else if (yDisplayed < yRange[0]) {
          y = yRange[1] - h;
        } else if (yDisplayed + h > yRange[1]) {
          y = yRange[0];
        }

        var xValue = xScale.invert(x);
        var yValue = yScale.invert(y);

        this.start()(datum, xValue);
        this.y()(datum, yValue);

        this.draw(item);
      }
    },
    resizeLeft: {
      value: function resizeLeft(item, dx, dy) {
        item = this.d3.select(item);
        var datum = item.datum();

        var constrains = this.param("edits");
        var canW = !! ~constrains.indexOf("width");
        // early return if cannot edit
        if (!canW) {
          return;
        }

        var accessors = this.getAccessors();
        var xRange = accessors.xScale.range();

        var x = accessors.x(datum);
        var w = accessors.w(datum);

        var targetX = x + dx;
        var targetW = w - dx;

        if (targetX >= xRange[0] && targetW >= this.__minWidth) {
          x = targetX;
          w = targetW;
        }

        var xValue = accessors.xScale.invert(x);
        var minDomain = accessors.xScale.domain()[0];
        var wValue = accessors.xScale.invert(w) - minDomain;

        this.start()(datum, xValue);
        this.duration()(datum, wValue);

        this.draw(item);
      }
    },
    resizeRight: {
      value: function resizeRight(item, dx, dy) {
        item = this.d3.select(item);
        var datum = item.datum();

        var constrains = this.param("edits");
        var canW = !! ~constrains.indexOf("width");
        // early return if cannot edit
        if (!canW) {
          return;
        }

        var accessors = this.getAccessors();
        var xRange = accessors.xScale.range();

        var x = accessors.x(datum);
        var w = accessors.w(datum);

        var targetW = w + dx;

        if (targetW >= this.__minWidth && x + targetW <= xRange[1]) {
          w = targetW;
        }

        var minDomain = accessors.xScale.domain()[0];
        var wValue = accessors.xScale.invert(w) - minDomain;
        this.duration()(datum, wValue);

        this.draw(item);
      }
    }
  });

  return Segment;
})(Layer);

// add and initialize our accessors
accessors.getFunction(Segment.prototype, ["y", "width", "color", "height", "duration", "start", "sortIndex", "opacity"]);

function factory() {
  return new Segment();
}
factory.Segment = Segment;

module.exports = factory;

// brushItem(extent, mode) {
/*
mode = mode || 'xy'; // default tries to match both
 var modeX = mode.indexOf('x') >= 0;
var modeY = mode.indexOf('y') >= 0;
var matchX = false, matchY = false;
 // data mappers
var start = this.start();
var duration = this.duration();
var y = this.y();
var height = this.height();
 this.g.selectAll('.selectable').classed('selected', (d, i) => {
  // var offsetTop = (that.top() || 0) + (that.base.margin().top || 0);
  // var offsetLeft = (that.left || 0) + (that.base.margin().left || 0);
   // X match
  if (modeX) {
    var x1 = start(d);
    var x2 = x1 + duration(d);
    //            begining sel               end sel
    var matchX1 = extent[0][0] <= x1 && x2 < extent[1][0];
    var matchX2 = extent[0][0] <= x2 && x1 < extent[1][0];
     matchX = (matchX1 || matchX2);
  } else {
    matchX = true;
  }
   // Y match
  if (modeY) {
    var y1 = y(d);
    var y2 = y1 + height(d);
    //            begining sel               end sel
    var matchY1 = extent[0][1] <= y1 && y2 < extent[1][1];
    var matchY2 = extent[0][1] <= y2 && y1 <= extent[1][1];
     matchY = (matchY1 || matchY2);
  } else {
    matchY = true;
  }
   return matchX && matchY;
});
*/
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVzNi9jb21wb25lbnRzL3NlZ21lbnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7Ozs7Ozs7ZUFFaUIsT0FBTyxDQUFDLGtCQUFrQixDQUFDOztJQUFuRCxRQUFRLFlBQVIsUUFBUTtJQUFFLFNBQVMsWUFBVCxTQUFTOztnQkFDVCxPQUFPLENBQUMsZUFBZSxDQUFDOztJQUFsQyxLQUFLLGFBQUwsS0FBSzs7SUFFTCxPQUFPO0FBRUEsV0FGUCxPQUFPLEdBRUc7MEJBRlYsT0FBTzs7QUFHVCxxQ0FIRSxPQUFPLDZDQUdEOztBQUVSLFFBQUksQ0FBQyxNQUFNLENBQUM7QUFDVixVQUFJLEVBQUUsU0FBUztBQUNmLGFBQU8sRUFBRSxDQUFDO0FBQ1YsV0FBSyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDO0FBQ3BDLGtCQUFZLEVBQUUsQ0FBQztBQUNmLG9CQUFjLEVBQUUsQ0FBQztLQUNsQixDQUFDLENBQUM7O0FBRUgsUUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUM7OztBQUdwQixRQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVMsQ0FBQyxFQUFZO1VBQVYsQ0FBQyxnQ0FBRyxJQUFJOztBQUN6QixVQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ2pDLE9BQUMsQ0FBQyxDQUFDLEdBQUksQ0FBQyxDQUFDLEFBQUMsQ0FBQztLQUNaLENBQUMsQ0FBQzs7QUFFSCxRQUFJLENBQUMsTUFBTSxDQUFDLFVBQVMsQ0FBQyxFQUFZO1VBQVYsQ0FBQyxnQ0FBRyxJQUFJOztBQUM5QixVQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDO0FBQ3RDLE9BQUMsQ0FBQyxNQUFNLEdBQUksQ0FBQyxDQUFDLEFBQUMsQ0FBQztLQUNqQixDQUFDLENBQUM7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U0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQ3ZDLEdBQUcsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLENBQzdFLENBQUMsQ0FBQzs7QUFFSCxTQUFTLE9BQU8sR0FBRztBQUFFLFNBQU8sSUFBSSxPQUFPLEVBQUUsQ0FBQztDQUFFO0FBQzVDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDOztBQUUxQixNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsImZpbGUiOiJlczYvY29tcG9uZW50cy9zZWdtZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgeyB1bmlxdWVJZCwgYWNjZXNzb3JzIH0gPSByZXF1aXJlKCcuLi9oZWxwZXJzL3V0aWxzJyk7XG52YXIgeyBMYXllciB9ID0gcmVxdWlyZSgnLi4vY29yZS9sYXllcicpO1xuXG5jbGFzcyBTZWdtZW50IGV4dGVuZHMgTGF5ZXIge1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgLy8gc2V0IGxheWVyIGRlZmF1bHRzXG4gICAgdGhpcy5wYXJhbXMoe1xuICAgICAgdHlwZTogJ3NlZ21lbnQnLFxuICAgICAgb3BhY2l0eTogMSxcbiAgICAgIGVkaXRzOiBbJ3gnLCAneScsICd3aWR0aCcsICdoZWlnaHQnXSxcbiAgICAgIGhhbmRsZXJXaWR0aDogMixcbiAgICAgIGhhbmRsZXJPcGFjaXR5OiAwXG4gICAgfSk7XG5cbiAgICB0aGlzLl9fbWluV2lkdGggPSAxO1xuXG4gICAgLy8gaW5pdGlhbGl6ZSBkYXRhIGFjY2Vzc29yc1xuICAgIHRoaXMueShmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHJldHVybiArZC55IHx8IDA7XG4gICAgICBkLnkgPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5oZWlnaHQoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSByZXR1cm4gK2QuaGVpZ2h0IHx8IDE7XG4gICAgICBkLmhlaWdodCA9ICgrdik7XG4gICAgfSk7XG5cbiAgICB0aGlzLmR1cmF0aW9uKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgcmV0dXJuICtkLmR1cmF0aW9uIHx8IDE7XG4gICAgICBkLmR1cmF0aW9uID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMuc3RhcnQoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSByZXR1cm4gK2Quc3RhcnQgfHwgMDtcbiAgICAgIGQuc3RhcnQgPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5jb2xvcihmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHJldHVybiBkLmNvbG9yID8gZC5jb2xvciArICcnIDogJyMwMDAwMDAnO1xuICAgICAgZC5jb2xvciA9IHYgKyAnJztcbiAgICB9KTtcblxuICAgIHRoaXMub3BhY2l0eShmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHJldHVybiBkLm9wYWNpdHk7XG4gICAgICBkLm9wYWNpdHkgPSB2ICsgJyc7XG4gICAgfSk7XG4gIH1cblxuICAvLyBATk9URSBhZGQgc29tZSBjYWNoaW5nIHN5c3RlbSA/XG4gIGdldEFjY2Vzc29ycygpIHtcbiAgICAvLyByZXZlcnNlIHlTY2FsZSB0byBoYXZlIGxvZ2ljYWwgc2l6ZXNcbiAgICAvLyBvbmx5IHkgaXMgcHJvYmxlbWF0aWMgdGhpcyB3YXlcbiAgICB2YXIgeFNjYWxlID0gdGhpcy5iYXNlLnhTY2FsZTtcbiAgICB2YXIgeVNjYWxlID0gdGhpcy55U2NhbGUuY29weSgpO1xuICAgIHlTY2FsZS5yYW5nZSh5U2NhbGUucmFuZ2UoKS5zbGljZSgwKS5yZXZlcnNlKCkpO1xuICAgIHZhciBoZWlnaHQgPSB5U2NhbGUucmFuZ2UoKVsxXTtcbiAgICB2YXIgbWluRG9tYWluID0geFNjYWxlLmRvbWFpbigpWzBdO1xuXG4gICAgdmFyIF94ID0gdGhpcy5zdGFydCgpO1xuICAgIHZhciBfeSA9IHRoaXMueSgpO1xuICAgIHZhciBfdyA9IHRoaXMuZHVyYXRpb24oKTtcbiAgICB2YXIgX2ggPSB0aGlzLmhlaWdodCgpO1xuXG4gICAgdmFyIF9jb2xvciAgICA9IHRoaXMuY29sb3IoKTtcbiAgICB2YXIgX29wYWNpdHkgID0gdGhpcy5vcGFjaXR5KCk7XG5cbiAgICAvLyBkZWZpbmUgYWNjZXNvcnNcbiAgICB2YXIgeCA9IChkKSA9PiB7IHJldHVybiB4U2NhbGUoX3goZCkpOyB9O1xuICAgIHZhciB3ID0gKGQpID0+IHtcbiAgICAgIHZhciB3aWR0aCA9IHhTY2FsZShtaW5Eb21haW4gKyBfdyhkKSk7XG4gICAgICByZXR1cm4gd2lkdGggPCAwID8gMCA6IHdpZHRoO1xuICAgIH07XG4gICAgdmFyIGggPSAoZCkgPT4geyByZXR1cm4geVNjYWxlKF9oKGQpKTsgfTtcbiAgICB2YXIgeSA9IChkKSA9PiB7IHJldHVybiBoZWlnaHQgLSBoKGQpIC0geVNjYWxlKF95KGQpKTsgfTtcblxuICAgIHZhciBjb2xvciA9IChkKSA9PiB7IHJldHVybiBfY29sb3IoZCk7IH07XG4gICAgdmFyIG9wYWNpdHkgPSAoZCkgPT4geyByZXR1cm4gKF9vcGFjaXR5KGQpIHx8IHRoaXMucGFyYW0oJ29wYWNpdHknKSk7IH07XG5cbiAgICB2YXIgX2hhbmRsZXJXaWR0aCA9IHBhcnNlSW50KHRoaXMucGFyYW0oJ2hhbmRsZXJXaWR0aCcpLCAxMCk7XG4gICAgdmFyIF9oYWxmSGFuZGxlciA9IF9oYW5kbGVyV2lkdGggKiAwLjU7XG5cbiAgICAvLyBoYW5kbGVyIHBvc2l0aW9uXG4gICAgdmFyIHJoeCA9IChkKSA9PiB7XG4gICAgICBsZXQgd2lkdGggPSB3KGQpO1xuXG4gICAgICByZXR1cm4gKHdpZHRoIDwgKF9oYW5kbGVyV2lkdGggKiAyKSkgP1xuICAgICAgICBfaGFuZGxlcldpZHRoICsgdGhpcy5fX21pbldpZHRoIDogd2lkdGggLSBfaGFsZkhhbmRsZXI7XG4gICAgfTtcblxuICAgIHJldHVybiB7IHcsIGgsIHgsIHksIGNvbG9yLCBvcGFjaXR5LCB4U2NhbGUsIHlTY2FsZSwgcmh4IH07XG4gIH1cblxuICB1cGRhdGUoZGF0YSkge1xuICAgIHN1cGVyLnVwZGF0ZShkYXRhKTtcblxuICAgIHRoaXMuaXRlbXMgPSB0aGlzLmcuc2VsZWN0QWxsKCcuJyArIHRoaXMucGFyYW0oJ3VuaXRDbGFzcycpKVxuICAgICAgLmRhdGEodGhpcy5kYXRhKCkpO1xuXG4gICAgdmFyIHNlbCA9IHRoaXMuaXRlbXMuZW50ZXIoKVxuICAgICAgLmFwcGVuZCgnZycpXG4gICAgICAuY2xhc3NlZCgnaXRlbScsIHRydWUpXG4gICAgICAuY2xhc3NlZCh0aGlzLnBhcmFtKCd1bml0Q2xhc3MnKSwgdHJ1ZSk7XG5cbiAgICBzZWwuYXBwZW5kKCdyZWN0Jyk7XG5cbiAgICBpZiAodGhpcy5wYXJhbSgnaW50ZXJhY3Rpb25zJykuZWRpdGFibGUpIHtcbiAgICAgIHNlbC5hcHBlbmQoJ2xpbmUnKVxuICAgICAgICAuYXR0cignY2xhc3MnLCAnaGFuZGxlIGxlZnQnKVxuICAgICAgICAuYXR0cignc3Ryb2tlLXdpZHRoJywgdGhpcy5wYXJhbSgnaGFuZGxlcldpZHRoJykpXG4gICAgICAgIC5hdHRyKCdzdHJva2Utb3BhY2l0eScsIHRoaXMucGFyYW0oJ2hhbmRsZXJPcGFjaXR5JykpO1xuXG4gICAgICBzZWwuYXBwZW5kKCdsaW5lJylcbiAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ2hhbmRsZSByaWdodCcpXG4gICAgICAgIC5hdHRyKCdzdHJva2Utd2lkdGgnLCB0aGlzLnBhcmFtKCdoYW5kbGVyV2lkdGgnKSlcbiAgICAgICAgLmF0dHIoJ3N0cm9rZS1vcGFjaXR5JywgdGhpcy5wYXJhbSgnaGFuZGxlck9wYWNpdHknKSk7XG4gICAgfVxuXG4gICAgdGhpcy5pdGVtcy5leGl0KCkucmVtb3ZlKCk7XG4gIH1cblxuICBkcmF3KGVsID0gbnVsbCkge1xuICAgIGVsID0gZWwgfHwgdGhpcy5pdGVtcztcblxuICAgIHZhciBhY2Nlc3NvcnMgPSB0aGlzLmdldEFjY2Vzc29ycygpO1xuXG4gICAgZWwuYXR0cigndHJhbnNmb3JtJywgKGQpID0+IHtcbiAgICAgIHJldHVybiAndHJhbnNsYXRlKCcgKyBhY2Nlc3NvcnMueChkKSArICcsICcgKyBhY2Nlc3NvcnMueShkKSArICcpJztcbiAgICB9KTtcblxuICAgIGVsLnNlbGVjdEFsbCgncmVjdCcpXG4gICAgICAuYXR0cigneCcsIDApXG4gICAgICAuYXR0cigneScsIDApXG4gICAgICAuYXR0cignd2lkdGgnLCBhY2Nlc3NvcnMudylcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCBhY2Nlc3NvcnMuaClcbiAgICAgIC5hdHRyKCdmaWxsJywgYWNjZXNzb3JzLmNvbG9yKVxuICAgICAgLmF0dHIoJ2ZpbGwtb3BhY2l0eScsIGFjY2Vzc29ycy5vcGFjaXR5KTtcblxuICAgIGlmICghIXRoaXMuZWFjaCgpKSB7IGVsLmVhY2godGhpcy5lYWNoKCkpOyB9XG5cbiAgICBpZiAodGhpcy5wYXJhbSgnaW50ZXJhY3Rpb25zJykuZWRpdGFibGUpIHtcblxuICAgICAgdmFyIF9oYW5kbGVyV2lkdGggPSBwYXJzZUludCh0aGlzLnBhcmFtKCdoYW5kbGVyV2lkdGgnKSwgMTApO1xuICAgICAgdmFyIF9oYWxmSGFuZGxlciA9IF9oYW5kbGVyV2lkdGggKiAwLjU7XG5cbiAgICAgIGVsLnNlbGVjdEFsbCgnLmhhbmRsZS5sZWZ0JylcbiAgICAgICAgLmF0dHIoJ3gxJywgX2hhbGZIYW5kbGVyKVxuICAgICAgICAuYXR0cigneDInLCBfaGFsZkhhbmRsZXIpXG4gICAgICAgIC5hdHRyKCd5MScsIDApXG4gICAgICAgIC5hdHRyKCd5MicsIGFjY2Vzc29ycy5oKVxuICAgICAgICAuc3R5bGUoJ3N0cm9rZScsIGFjY2Vzc29ycy5jb2xvcik7XG5cbiAgICAgIGVsLnNlbGVjdEFsbCgnLmhhbmRsZS5yaWdodCcpXG4gICAgICAgIC5hdHRyKCd4MScsIDApXG4gICAgICAgIC5hdHRyKCd4MicsIDApXG4gICAgICAgIC5hdHRyKCd5MScsIDApXG4gICAgICAgIC5hdHRyKCd5MicsIGFjY2Vzc29ycy5oKVxuICAgICAgICAuYXR0cigndHJhbnNmb3JtJywgKGQpID0+IHtcbiAgICAgICAgICByZXR1cm4gJ3RyYW5zbGF0ZSgnICsgYWNjZXNzb3JzLnJoeChkKSArICcsIDApJztcbiAgICAgICAgfSlcbiAgICAgICAgLnN0eWxlKCdzdHJva2UnLCBhY2Nlc3NvcnMuY29sb3IpO1xuICAgIH1cbiAgfVxuXG4gIHhab29tKHZhbCkge1xuICAgIHRoaXMuZHJhdygpO1xuICB9XG5cbiAgLy8gbG9naWMgcGVyZm9ybWVkIHRvIHNlbGVjdCBhbiBpdGVtIGZyb20gdGhlIGJydXNoXG4gIGhhbmRsZUJydXNoKGV4dGVudCwgZSkge1xuICAvLyBicnVzaEl0ZW0oZXh0ZW50LCBtb2RlKSB7XG4gICAgLypcbiAgICBtb2RlID0gbW9kZSB8fCAneHknOyAvLyBkZWZhdWx0IHRyaWVzIHRvIG1hdGNoIGJvdGhcblxuICAgIHZhciBtb2RlWCA9IG1vZGUuaW5kZXhPZigneCcpID49IDA7XG4gICAgdmFyIG1vZGVZID0gbW9kZS5pbmRleE9mKCd5JykgPj0gMDtcbiAgICB2YXIgbWF0Y2hYID0gZmFsc2UsIG1hdGNoWSA9IGZhbHNlO1xuXG4gICAgLy8gZGF0YSBtYXBwZXJzXG4gICAgdmFyIHN0YXJ0ID0gdGhpcy5zdGFydCgpO1xuICAgIHZhciBkdXJhdGlvbiA9IHRoaXMuZHVyYXRpb24oKTtcbiAgICB2YXIgeSA9IHRoaXMueSgpO1xuICAgIHZhciBoZWlnaHQgPSB0aGlzLmhlaWdodCgpO1xuXG4gICAgdGhpcy5nLnNlbGVjdEFsbCgnLnNlbGVjdGFibGUnKS5jbGFzc2VkKCdzZWxlY3RlZCcsIChkLCBpKSA9PiB7XG4gICAgICAvLyB2YXIgb2Zmc2V0VG9wID0gKHRoYXQudG9wKCkgfHwgMCkgKyAodGhhdC5iYXNlLm1hcmdpbigpLnRvcCB8fCAwKTtcbiAgICAgIC8vIHZhciBvZmZzZXRMZWZ0ID0gKHRoYXQubGVmdCB8fCAwKSArICh0aGF0LmJhc2UubWFyZ2luKCkubGVmdCB8fCAwKTtcblxuICAgICAgLy8gWCBtYXRjaFxuICAgICAgaWYgKG1vZGVYKSB7XG4gICAgICAgIHZhciB4MSA9IHN0YXJ0KGQpO1xuICAgICAgICB2YXIgeDIgPSB4MSArIGR1cmF0aW9uKGQpO1xuICAgICAgICAvLyAgICAgICAgICAgIGJlZ2luaW5nIHNlbCAgICAgICAgICAgICAgIGVuZCBzZWxcbiAgICAgICAgdmFyIG1hdGNoWDEgPSBleHRlbnRbMF1bMF0gPD0geDEgJiYgeDIgPCBleHRlbnRbMV1bMF07XG4gICAgICAgIHZhciBtYXRjaFgyID0gZXh0ZW50WzBdWzBdIDw9IHgyICYmIHgxIDwgZXh0ZW50WzFdWzBdO1xuXG4gICAgICAgIG1hdGNoWCA9IChtYXRjaFgxIHx8IG1hdGNoWDIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWF0Y2hYID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gWSBtYXRjaFxuICAgICAgaWYgKG1vZGVZKSB7XG4gICAgICAgIHZhciB5MSA9IHkoZCk7XG4gICAgICAgIHZhciB5MiA9IHkxICsgaGVpZ2h0KGQpO1xuICAgICAgICAvLyAgICAgICAgICAgIGJlZ2luaW5nIHNlbCAgICAgICAgICAgICAgIGVuZCBzZWxcbiAgICAgICAgdmFyIG1hdGNoWTEgPSBleHRlbnRbMF1bMV0gPD0geTEgJiYgeTIgPCBleHRlbnRbMV1bMV07XG4gICAgICAgIHZhciBtYXRjaFkyID0gZXh0ZW50WzBdWzFdIDw9IHkyICYmIHkxIDw9IGV4dGVudFsxXVsxXTtcblxuICAgICAgICBtYXRjaFkgPSAobWF0Y2hZMSB8fCBtYXRjaFkyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1hdGNoWSA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBtYXRjaFggJiYgbWF0Y2hZO1xuICAgIH0pO1xuICAgICovXG4gIH1cblxuICBoYW5kbGVEcmFnKGl0ZW0sIGUpIHtcbiAgICBpZiAoaXRlbSA9PT0gbnVsbCkgeyByZXR1cm47IH1cblxuICAgIHZhciBjbGFzc0xpc3QgPSBlLnRhcmdldC5jbGFzc0xpc3Q7XG4gICAgdmFyIG1vZGUgPSAnbW92ZSc7XG4gICAgLy8gaWYgdGhlIHRhcmdldCBpcyBhbiBoYW5kbGVyXG4gICAgaWYgKGNsYXNzTGlzdC5jb250YWlucygnbGVmdCcpKSB7IG1vZGUgPSAncmVzaXplTGVmdCc7IH1cbiAgICBpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdyaWdodCcpKSB7IG1vZGUgPSAncmVzaXplUmlnaHQnOyB9XG5cbiAgICB0aGlzW21vZGVdKGl0ZW0sIGUub3JpZ2luYWxFdmVudC5keCwgZS5vcmlnaW5hbEV2ZW50LmR5KTtcbiAgfVxuXG4gIG1vdmUoaXRlbSwgZHgsIGR5KSB7XG4gICAgaXRlbSA9IHRoaXMuZDMuc2VsZWN0KGl0ZW0pO1xuICAgIHZhciBkYXR1bSA9IGl0ZW0uZGF0dW0oKTtcbiAgICAvLyBkZWZpbmUgY29uc3RyYWluc1xuICAgIHZhciBjb25zdHJhaW5zID0gdGhpcy5wYXJhbSgnZWRpdHMnKTtcbiAgICB2YXIgY2FuWCA9ICEhfmNvbnN0cmFpbnMuaW5kZXhPZigneCcpO1xuICAgIHZhciBjYW5ZID0gISF+Y29uc3RyYWlucy5pbmRleE9mKCd5Jyk7XG4gICAgLy8gZWFybHkgcmV0dXJuIGlmIGNhbm5vdCBlZGl0IHggYW5kIHlcbiAgICBpZiAoIWNhblggJiYgIWNhblkpIHsgcmV0dXJuOyB9XG4gICAgLy8gZWxzZSBsb2NrIHRoZSBjb3JyZXNwb25kaW5nIGF4aXNcbiAgICBpZiAoIWNhblgpIHsgZHggPSAwOyB9XG4gICAgaWYgKCFjYW5ZKSB7IGR5ID0gMDsgfVxuXG4gICAgdmFyIGFjY2Vzc29ycyA9IHRoaXMuZ2V0QWNjZXNzb3JzKCk7XG5cbiAgICB2YXIgeFNjYWxlID0gYWNjZXNzb3JzLnhTY2FsZTtcbiAgICB2YXIgeVNjYWxlID0gYWNjZXNzb3JzLnlTY2FsZTtcbiAgICB2YXIgeFJhbmdlID0geFNjYWxlLnJhbmdlKCk7XG4gICAgdmFyIHlSYW5nZSA9IHlTY2FsZS5yYW5nZSgpO1xuXG4gICAgdmFyIHggPSBhY2Nlc3NvcnMueChkYXR1bSk7XG4gICAgdmFyIHcgPSBhY2Nlc3NvcnMudyhkYXR1bSk7XG4gICAgdmFyIGggPSBhY2Nlc3NvcnMuaChkYXR1bSk7XG4gICAgdmFyIHkgPSB5U2NhbGUodGhpcy55KCkoZGF0dW0pKTtcblxuICAgIC8vIGhhbmRsZSB4IHBvc2l0aW9uIC0gbG9jayB0byBib3VuZGFyaWVzXG4gICAgdmFyIHRhcmdldFggPSB4ICsgZHg7XG4gICAgLypcbiAgICBpZiAodGFyZ2V0WCA+PSB4UmFuZ2VbMF0gJiYgKHRhcmdldFggKyB3KSA8PSB4UmFuZ2VbMV0pIHtcbiAgICAgIHggPSB0YXJnZXRYO1xuICAgIH0gZWxzZSBpZiAodGFyZ2V0WCA8IHhSYW5nZVswXSkge1xuICAgICAgeCA9IHhSYW5nZVswXTtcbiAgICB9IGVsc2UgaWYgKCh0YXJnZXRYICsgdykgPiB4UmFuZ2VbMV0pIHtcbiAgICAgIHggPSB4UmFuZ2VbMV0gLSB3O1xuICAgIH1cbiAgICAqL1xuICAgIGlmICh0YXJnZXRYID49IHhSYW5nZVswXSAmJiAodGFyZ2V0WCArIHcpIDw9IHhSYW5nZVsxXSkge1xuICAgICAgeCA9IHRhcmdldFg7XG4gICAgfSBlbHNlIGlmICh0YXJnZXRYIDwgeFJhbmdlWzBdKSB7XG4gICAgICB4ID0geFJhbmdlWzBdO1xuICAgIH0gZWxzZSBpZiAoKHRhcmdldFggKyB3KSA+IHhSYW5nZVsxXSkge1xuICAgICAgeCA9IHRhcmdldFg7XG4gICAgfVxuXG4gICAgLy8gaGFuZGxlIHkgcG9zaXRpb24gLSBsb2NrIHRvIGJvdW5kYXJpZXNcbiAgICB2YXIgdGFyZ2V0WSA9IHkgLSBkeTtcbiAgICB2YXIgeURpc3BsYXllZCA9IHlSYW5nZVsxXSAtIGggLSB0YXJnZXRZO1xuXG4gICAgaWYgKHlEaXNwbGF5ZWQgPj0geVJhbmdlWzBdICYmICh5RGlzcGxheWVkICsgaCkgPD0geVJhbmdlWzFdKSB7XG4gICAgICB5ID0gdGFyZ2V0WTtcbiAgICB9IGVsc2UgaWYgKHlEaXNwbGF5ZWQgPCB5UmFuZ2VbMF0pIHtcbiAgICAgIHkgPSB5UmFuZ2VbMV0gLSBoO1xuICAgIH0gZWxzZSBpZiAoKHlEaXNwbGF5ZWQgKyBoKSA+IHlSYW5nZVsxXSkge1xuICAgICAgeSA9IHlSYW5nZVswXTtcbiAgICB9XG5cbiAgICB2YXIgeFZhbHVlID0geFNjYWxlLmludmVydCh4KTtcbiAgICB2YXIgeVZhbHVlID0geVNjYWxlLmludmVydCh5KTtcblxuICAgIHRoaXMuc3RhcnQoKShkYXR1bSwgeFZhbHVlKTtcbiAgICB0aGlzLnkoKShkYXR1bSwgeVZhbHVlKTtcblxuICAgIHRoaXMuZHJhdyhpdGVtKTtcbiAgfVxuXG4gIHJlc2l6ZUxlZnQoaXRlbSwgZHgsIGR5KSB7XG4gICAgaXRlbSA9IHRoaXMuZDMuc2VsZWN0KGl0ZW0pO1xuICAgIHZhciBkYXR1bSA9IGl0ZW0uZGF0dW0oKTtcblxuICAgIHZhciBjb25zdHJhaW5zID0gdGhpcy5wYXJhbSgnZWRpdHMnKTtcbiAgICB2YXIgY2FuVyA9ICEhfmNvbnN0cmFpbnMuaW5kZXhPZignd2lkdGgnKTtcbiAgICAvLyBlYXJseSByZXR1cm4gaWYgY2Fubm90IGVkaXRcbiAgICBpZiAoIWNhblcpIHsgcmV0dXJuOyB9XG5cbiAgICB2YXIgYWNjZXNzb3JzID0gdGhpcy5nZXRBY2Nlc3NvcnMoKTtcbiAgICB2YXIgeFJhbmdlID0gYWNjZXNzb3JzLnhTY2FsZS5yYW5nZSgpO1xuXG4gICAgdmFyIHggPSBhY2Nlc3NvcnMueChkYXR1bSk7XG4gICAgdmFyIHcgPSBhY2Nlc3NvcnMudyhkYXR1bSk7XG5cbiAgICB2YXIgdGFyZ2V0WCA9IHggKyBkeDtcbiAgICB2YXIgdGFyZ2V0VyA9IHcgLSBkeDtcblxuICAgIGlmICh0YXJnZXRYID49IHhSYW5nZVswXSAmJiB0YXJnZXRXID49IHRoaXMuX19taW5XaWR0aCkge1xuICAgICAgeCA9IHRhcmdldFg7XG4gICAgICB3ID0gdGFyZ2V0VztcbiAgICB9XG5cbiAgICB2YXIgeFZhbHVlID0gYWNjZXNzb3JzLnhTY2FsZS5pbnZlcnQoeCk7XG4gICAgdmFyIG1pbkRvbWFpbiA9IGFjY2Vzc29ycy54U2NhbGUuZG9tYWluKClbMF07XG4gICAgdmFyIHdWYWx1ZSA9IGFjY2Vzc29ycy54U2NhbGUuaW52ZXJ0KHcpIC0gbWluRG9tYWluO1xuXG4gICAgdGhpcy5zdGFydCgpKGRhdHVtLCB4VmFsdWUpO1xuICAgIHRoaXMuZHVyYXRpb24oKShkYXR1bSwgd1ZhbHVlKTtcblxuICAgIHRoaXMuZHJhdyhpdGVtKTtcbiAgfVxuXG4gIHJlc2l6ZVJpZ2h0KGl0ZW0sIGR4LCBkeSkge1xuICAgIGl0ZW0gPSB0aGlzLmQzLnNlbGVjdChpdGVtKTtcbiAgICB2YXIgZGF0dW0gPSBpdGVtLmRhdHVtKCk7XG5cbiAgICB2YXIgY29uc3RyYWlucyA9IHRoaXMucGFyYW0oJ2VkaXRzJyk7XG4gICAgdmFyIGNhblcgPSAhIX5jb25zdHJhaW5zLmluZGV4T2YoJ3dpZHRoJyk7XG4gICAgLy8gZWFybHkgcmV0dXJuIGlmIGNhbm5vdCBlZGl0XG4gICAgaWYgKCFjYW5XKSB7IHJldHVybjsgfVxuXG4gICAgdmFyIGFjY2Vzc29ycyA9IHRoaXMuZ2V0QWNjZXNzb3JzKCk7XG4gICAgdmFyIHhSYW5nZSA9IGFjY2Vzc29ycy54U2NhbGUucmFuZ2UoKTtcblxuICAgIHZhciB4ID0gYWNjZXNzb3JzLngoZGF0dW0pO1xuICAgIHZhciB3ID0gYWNjZXNzb3JzLncoZGF0dW0pO1xuXG4gICAgdmFyIHRhcmdldFcgPSB3ICsgZHg7XG5cbiAgICBpZiAodGFyZ2V0VyA+PSB0aGlzLl9fbWluV2lkdGggJiYgKHggKyB0YXJnZXRXKSA8PSB4UmFuZ2VbMV0pIHtcbiAgICAgIHcgPSB0YXJnZXRXO1xuICAgIH1cblxuICAgIHZhciBtaW5Eb21haW4gPSBhY2Nlc3NvcnMueFNjYWxlLmRvbWFpbigpWzBdO1xuICAgIHZhciB3VmFsdWUgPSBhY2Nlc3NvcnMueFNjYWxlLmludmVydCh3KSAtIG1pbkRvbWFpbjtcbiAgICB0aGlzLmR1cmF0aW9uKCkoZGF0dW0sIHdWYWx1ZSk7XG5cbiAgICB0aGlzLmRyYXcoaXRlbSk7XG4gIH1cblxufVxuXG4vLyBhZGQgYW5kIGluaXRpYWxpemUgb3VyIGFjY2Vzc29yc1xuYWNjZXNzb3JzLmdldEZ1bmN0aW9uKFNlZ21lbnQucHJvdG90eXBlLCBbXG4gICd5JywgJ3dpZHRoJywgJ2NvbG9yJywgJ2hlaWdodCcsICdkdXJhdGlvbicsICdzdGFydCcsICdzb3J0SW5kZXgnLCAnb3BhY2l0eSdcbl0pO1xuXG5mdW5jdGlvbiBmYWN0b3J5KCkgeyByZXR1cm4gbmV3IFNlZ21lbnQoKTsgfVxuZmFjdG9yeS5TZWdtZW50ID0gU2VnbWVudDtcblxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5OyJdfQ==